#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <err.h>
#include <sys/wait.h>
#include <string.h>

enum
{ Bufsize = 512, MAXTOKENS = 32 };

int
tokenize (char *str, char *tokens[], char *delim, int max)
{
  int i = 0;
  char *p;

  while (((p = strtok_r (str, delim, &str)) != NULL) && (i < max))
    {
      tokens[i] = p;
      i++;

    }
  return i;
}


void
hijo_ps (int p[2])
{
  dup2 (p[1], 1);
  close (p[0]);
  close (p[1]);
  execl ("/usr/bin/ps", "ps", "aux", NULL);
  err (EXIT_FAILURE, "exec failed");
}


void
hijo_lector (int p[2], char *pid_buscado)
{
  char buf[Bufsize];
  FILE *fp;
  char *tokens[MAXTOKENS];
  int exit_status;

  close (p[1]);
  fp = fdopen (p[0], "r");
  if (fp == NULL)
    err (EXIT_FAILURE, "fdopen failed");

  exit_status = 1;
  while ((fgets (buf, Bufsize, fp) != NULL) && (exit_status))
    {
      tokenize (buf, tokens, " ", MAXTOKENS);
      if (strcmp (tokens[1], pid_buscado) == 0)
	exit_status = 0;
    }
  fclose (fp);
  exit (exit_status);
}

int
main (int argc, char *argv[])
{
  int p[2];
  int exit_status = 1;
  int sts;
  int pidson;
  int pidexit;

  if (argc != 2)
    errx (EXIT_FAILURE, "Usage:%s pid", argv[0]);

  pipe (p);
  switch (fork ())
    {
    case -1:
      err (EXIT_FAILURE, "fork failed");
    case 0:
      hijo_ps (p);
    }

  switch (pidson = fork ())
    {
    case -1:
      err (EXIT_FAILURE, "fork failed");
    case 0:
      hijo_lector (p, argv[1]);
    }

  close (p[0]);
  close (p[1]);

  while ((pidexit = wait (&sts)) != -1)
    {
      if (WIFEXITED (sts))
	{
	  if (pidexit == pidson)
	    exit_status = WEXITSTATUS (sts);
	}
    }

  exit (exit_status);
}
